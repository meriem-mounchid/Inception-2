FROM debian:buster

RUN apt-get update
RUN apt-get install php-fpm php-mysql curl wget git vim -y

RUN mkdir -p /var/www/html/wordpress

WORKDIR /var/www/html/wordpress

COPY ./script.sh /
# COPY ./wp-config.php /var/www/html/wordpress/wp-config.php
RUN curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
RUN chmod +x wp-cli.phar
RUN mv wp-cli.phar /usr/local/bin/wp
RUN wp core download --allow-root

RUN mv /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php

RUN sed -i 's/database_name_here/misaki_db/' /var/www/html/wordpress/wp-config.php
RUN sed -i 's/username_here/misaki_user/' /var/www/html/wordpress/wp-config.php
RUN sed -i 's/password_here/misaki/' /var/www/html/wordpress/wp-config.php
RUN sed -i 's/localhost/mariadb/' /var/www/html/wordpress/wp-config.php
RUN sed -i "85i define('WP_REDIS_PORT', 6379);" /var/www/html/wordpress/wp-config.php
RUN sed -i "86i define('WP_REDIS_HOST', 'redis');" /var/www/html/wordpress/wp-config.php

# RUN echo "define('WP_REDIS_PORT', 6379);" >> /var/www/html/wordpress/wp-config.php
# RUN echo "define('WP_REDIS_HOST', 'redis');" >> /var/www/html/wordpress/wp-config.php

RUN rm /etc/php/7.3/fpm/pool.d/www.conf
COPY ./www.conf /etc/php/7.3/fpm/pool.d/www.conf
RUN chmod 777 /script.sh
RUN chmod 777 /etc/php/7.3/fpm/pool.d/www.conf

EXPOSE 9000
CMD ["/script.sh"]